# securityhub_enabled.yml

# 자동 조치 X / 알림만
# 위반 사항 : AWS Security Hub 비활성화 상태로 인해 보안 이벤트 통합 모니터링 미흡 및 ISMS-P 보안 요구사항 위반
# 이유 : Security Hub 활성화는 Cloud Custodian에서 직접 수행할 수 없으며, 현재 리소스 상태를 기준으로 이벤트 발생 시점에 알림만 가능하므로, Slack 알림 전송으로 대응
# Custodian의 aws.account 리소스는 securityhub_enabled 값을 필터링할 수는 있으나, Security Hub를 활성화하는 action은 지원하지 않음.

policies:
  - name: notify-securityhub-disabled 
    resource: aws.account 
    description: AWS Security Hub disabled causing integrated security monitoring gaps and ISMS-P compliance violations.

    mode:
      type: periodic 
      schedule: "rate(1 day)" 
      role: arn:aws:iam::311278774159:role/custodian-lambda-role 

    filters:
      - type: value  
        key: "securityhub_enabled" 
        value: false  

    actions:
      - type: notify  
        slack_template: slack_default
        slack_msg_color: danger
        violation_desc: |
          *** CHECKID : "securityhub_enabled" ***
          해당 S3 버킷은 접근 로그(Access Logging)가 비활성화되어 있어 로그 추적이 불가능한 상태입니다. 
        action_desc: |
          CloudTrail 로그 버킷과 기타 중요 로그 저장 버킷의 Access Logging 설정을 정기적으로 점검하고 순환 참조가 발생하지 않도록 주의하세요.
        to:
          - "${SLACK_WEBHOOK_URL}"
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/${ACCOUNT_ID}/custodian-notify-queue