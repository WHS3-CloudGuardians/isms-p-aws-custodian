# 2-cloudwatch_changes_to_network_route_tables_alarm_configured.yml

# 자동조치 X / 알림만 
# 위반 사항 :라우팅 테이블의 무단 변경으로 인한 네트워크 트래픽 우회 및 데이터 유출 위험
# 이유 : 실시간 운영 중인 네트워크를 자동으로 수정하면 서비스 장애 위험이 있음. 

policies:
  - name: monitor-route-table-changes
    resource: aws.account
    description: Monitor route table changes that may pose a risk of unauthorized network routing.
    
    mode:
      type: cloudtrail
      role: arn:aws:iam::311278774159:role/custodian-lambda-role
      events:
        - source: ec2.amazonaws.com
          event: CreateRoute
          ids: "requestParameters.routeTableId"
        - source: ec2.amazonaws.com
          event: ReplaceRoute
          ids: "requestParameters.routeTableId"
        - source: ec2.amazonaws.com
          event: DeleteRoute
          ids: "requestParameters.routeTableId"
          
    actions:
      - type: notify
        template: default
        template_format: slack
        violation_desc: |
          *** CHECKID: "cloudwatch_changes_to_network_route_tables_alarm_configured" ***
          라우팅 테이블의 무단 변경으로 인한 네트워크 트래픽 우회 및 데이터 유출 위험이 있다. 
        action_desc: |
          해당 라우팅 테이블에 대해 CreateRoute, ReplaceRoute, DeleteRoute 등의 변경 이벤트가 감지되었습니다.
          변경된 경로 설정은 네트워크 트래픽의 우회 또는 외부 유출 가능성이 있으므로 관리자 검토가 필요합니다.
        to:
          - "${SLACK_WEBHOOK_URL}"
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/${ACCOUNT_ID}/custodian-notify-queue
---
# 4-cloudwatch_changes_to_vpcs_alarm_configured.yml

# 위반 사항 : 감한 VPC 설정 변경에 대한 실시간 알림 부재는 모니터링 및 변경관리 요구사항 위반
# 자동조치 X / 알림만 
# 이유 : VPC 생성·삭제·테넌시 변경은 라우팅 테이블, 인터넷 게이트웨이, 보안 그룹, 네트워크 ACL 등 여러 핵심 네트워크 컴포넌트와 연관되어 있어 수정 시 오류 발생함. 

policies:
  - name: cloudwatch-changes-to-vpcs-alarm-configured
    resource: aws.ec2
    description: |
      Missing real-time alerting for sensitive VPC configuration changes violates monitoring and change management requirements.

    mode:
      type: cloudtrail
      role: arn:aws:iam::311278774159:role/custodian-lambda-role
      events:
        - source: ec2.amazonaws.com
          event: CreateVpc
          ids: "responseElements.vpc.vpcId"
        - source: ec2.amazonaws.com
          event: DeleteVpc
          ids: "requestParameters.vpcId"
        - source: ec2.amazonaws.com
          event: ModifyVpcTenancy
          ids: "requestParameters.vpcId"
        - source: ec2.amazonaws.com
          event: ModifyVpcAttribute
          ids: "requestParameters.vpcId"

    filters:
      - type: value
        key: isDefault
        value: false

    actions:
      - type: notify
        template: default
        template_format: slack
        violation_desc: |
          *** CHECKID : "cloudwatch_changes_to_vpcs_alarm_configured" ***
          VPC 생성·삭제·속성 변경 감지되었습니다. 
        action_desc: |
          변경 의도를 확인하고 보안 그룹 및 라우팅 구성을 검토하세요.
        to:
          - "${SLACK_WEBHOOK_URL}"
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/${ACCOUNT_ID}/custodian-notify-queue
---
# 5-cloudwatch_cross_account_sharing_disabled.yml

# 자동조치 X / 알림만 
# 위반 사항 : 승인되지 않은 외부 AWS 계정이 CloudWatch 로그 그룹에 접근할 수 있도록 리소스 정책이 설정된 상태
# 이유 : CloudWatch 로그 그룹의 교차 계정 공유 정책을 자동 삭제하면 현재 운영 중인 모니터링/로깅 시스템이 즉시 중단되어 서비스 장애를 유발할 수 있기 때문에 수동 검토 후 조치하는 것이 안전합니다.

policies:
  - name: disable-cross-account-sharing-cloudwatch-logs
    resource: aws.log-group
    description: Detect and notify when CloudWatch Logs resource policy allows cross-account access.
    mode:
      type: periodic
      schedule: "rate(1 day)"
      role: arn:aws:iam::311278774159:role/custodian-lambda-role

    filters:
      - type: cross-account
        whitelist:
          - "311278774159"

    actions:
      - type: notify
        template: default
        template_format: slack
        violation_desc: |
          *** CHECKID : "cloudwatch_cross_account_sharing_disabled" ***
          CloudWatch Logs 리소스 정책에 불허된 교차 계정 접근이 감지되었습니다.
        action_desc: |
          리소스 정책에서 외부 계정에 대한 접근을 제거하거나, 승인된 계정만 허용하도록 업데이트하세요.
        to:
          - "${SLACK_WEBHOOK_URL}"
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/${ACCOUNT_ID}/custodian-notify-queue
---
# 7-cloudwatch_log_metric_filter_root_usage.yml

# 위반 사항 : 루트 계정 사용에 대한 로그 필터 및 경보가 없어 사용자 오남용 및 이상행위 탐지 미흡
# 자동 조치 X / 알림만
# 이유 : 루트 계정 사용 자체는 이미 발생한 이벤트이며 Cloud Custodian은 이를 사후 탐지할 수만 있고 사전 차단은 불가. 
# 루트 계정은 AWS 계정에서 가장 높은 권한을 보유하고 있음. 이것을 자동조치로 해결하면 다른 것들에도 문제가 생김. 
# 루트 계정 사용을 감지해서 IAM Role로 전환하거나 MFA 설정 여부를 추가로 점검하는 보완 정책도 설계 가능. 

policies:
  - name: alert-on-root-account-usage
    resource: aws.account
    description: AWS root account is used for console login.

    mode:
      type: cloudtrail     
      role: arn:aws:iam::311278774159:role/custodian-lambda-role 
      events:
        - source: signin.amazonaws.com       
          event: ConsoleLogin                   
          selector: "$.userIdentity.type == 'Root'"  
          ids: "userIdentity.accountId"         

    actions:
      - type: notify
        template: default
        template_format: slack
        violation_desc: |
          *** CHECKID: "cloudwatch_log_metric_filter_root_usage" ***
          루트 계정으로 AWS 콘솔에 로그인한 이벤트가 감지되었습니다.
        action_desc: |
          관리자 또는 보안 담당자가 로그인 내역(IP, 시간 등)을 확인하고 필요 시 계정 접근을 제한하거나 비밀번호를 변경하세요.
        to:
          - "${SLACK_WEBHOOK_URL}"
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/${ACCOUNT_ID}/custodian-notify-queue
---
# 8-cloudwatch_log_metric_filter_unauthorized_api_calls.yml

# 자동 조치 X / 알림만
# 위반 사항 : 비인가 API 호출에 대한 로그 필터 및 경보가 없어 이상행위 탐지 및 접근권한 관리 절차 위반
# 이유 : 비인가 API 호출은 이미 발생한 이벤트로 이를 실시간 차단하는 것은 불가능하며 사후 알림 및 분석만 가능

policies:
  - name: alert-unauthorized-api-calls 
    resource: account  
    description: Missing CloudWatch metric filter and alarm for unauthorized API calls, violating security monitoring and access control requirements.

    mode:
      type: cloudtrail
      role: arn:aws:iam::311278774159:role/custodian-lambda-role
      events:
        - source: "*"
          event: "*"
          ids: "eventID"

    filters:
      - type: event  
        key: errorCode  
        value: "*UnauthorizedOperation*"  
        op: glob  

    actions:
      - type: notify
        template: default
        template_format: slack
        violation_desc: |
          *** CHECKID: "cloudwatch_log_metric_filter_unauthorized_api_calls" ***
          비인가 API 호출이 탐지되었습니다. 계정 또는 역할의 접근 권한을 점검하시기 바랍니다.
        action_desc: |
          이미 발생한 비인가 API 호출에 대한 이벤트로 실시간 차단이 불가능합니다.
        to:
          - "${SLACK_WEBHOOK_URL}"
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/${ACCOUNT_ID}/custodian-notify-queue
---
# 9-cloudwatch_log_metric_filter_authentication_failures.yml

# 자동 조치 X / 알림만
# 인증 실패는 시스템 설정을 변경해 막는 것이 아닌 탐지 기반 대응. 그래서 알림만 보냄.  
# 정책 위반 내용: 인증 실패 이벤트(ConsoleLogin + Failed authentication)가 발생했지만 해당 이벤트를 모니터링하거나 알림을 보내는 CloudWatch 로그 그룹, 메트릭 필터, 알람이 구성되어 있지 않음.

policies:
  - name: notify-console-auth-failures 
    resource: aws.cloudtrail
    description: Detection of a failed AWS Console login event.
    
    mode:
      type: cloudtrail 
      role: arn:aws:iam::311278774159:role/custodian-lambda-role  
      events:
        - source: signin.amazonaws.com  
          event: ConsoleLogin  
          ids: "userIdentity.arn"  

    filters:
      - type: value  
        key: errorMessage 
        value: "Failed authentication"  

    actions:
      - type: notify
        template: default
        template_format: slack
        violation_desc: |
          *** CHECKID: "cloudwatch_log_metric_filter_authentication_failures" ***
          AWS 콘솔 로그인 인증 실패 이벤트가 발생했습니다.
        action_desc: |
          이 이벤트는 설정 변경으로 사전에 차단할 수 없어 보안 담당자의 수동 확인 및 대응이 필요합니다.
        to:
          - "${SLACK_WEBHOOK_URL}"
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/${ACCOUNT_ID}/custodian-notify-queue
---
# 10-cloudwatch_log_metric_filter_aws_organizations_changes.yml

# 위반 사항 : CloudWatch Log Group과 연결된 Metric Filter 및 Alarm이 존재하지 않음. AWS Organizations에 대한 변경이 발생하더라도 이를 탐지하거나 알림으로 통보할 수 없음.
# 자동 조치 X / 알림만
# 이유 : AWS Organizations의 설정 변경 이벤트(예: 계정 추가/삭제, 정책 변경 등)를 자동 차단 또는 롤백하는 것은 불가능. Organizations는 민감한 글로벌 리소스이며 변경을 자동으로 되돌리거나 막는 작업은 AWS API로도 제한적

policies:
  - name: monitor-aws-organizations-changes 
    resource: aws.account 
    description: Notification on AWS Organizations change events.

    mode:
      type: cloudtrail
      role: arn:aws:iam::311278774159:role/custodian-lambda-role
      events:
        - source: organizations.amazonaws.com
          event: CreateAccount
          ids: requestParameters.accountName
        - source: organizations.amazonaws.com
          event: InviteAccountToOrganization
          ids: requestParameters.target.email
        - source: organizations.amazonaws.com
          event: AttachPolicy
          ids: requestParameters.policyId
        - source: organizations.amazonaws.com
          event: DetachPolicy
          ids: requestParameters.policyId
        - source: organizations.amazonaws.com
          event: DeleteOrganization
          ids: eventSource
        - source: organizations.amazonaws.com
          event: CreateOrganizationalUnit
          ids: requestParameters.name
        - source: organizations.amazonaws.com
          event: DeleteOrganizationalUnit
          ids: requestParameters.organizationalUnitId 

    actions:
      - type: notify
        template: default
        template_format: slack
        violation_desc: |
          *** CHECKID: "cloudwatch_log_metric_filter_aws_organizations_changes" ***
          AWS Organizations 리소스에 변경 이벤트 발생했다. 
        action_desc: |
          Organizations는 민감한 리소스로 자동조치 불가하다. 보안 담당자가 확인하여 수동조치 한다. 
        to:
          - "${SLACK_WEBHOOK_URL}"
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/${ACCOUNT_ID}/custodian-notify-queue
---
# 12-cloudwatch_log_metric_filter_disable_or_scheduled_deletion_of_kms_cmk.yml

# 위반 사항 : KMS 키 삭제·비활성화 이벤트에 대한 로그 필터 및 경보가 없어 이상행위 탐지 및 암호키 관리 절차 위반 
# 자동 조치 X / 알림만
# 이유 : Cloud Custodian은 키 삭제 자체를 막을 수 없음 (이벤트 발생 후 동작). 향후 키 보호 조치(EnableKeyRotation, KeyPolicy 제한 등)는 별도 정책으로 구성 가능.

policies:
  - name: monitor-kms-key-deletion-or-disable  
    description: Detect KMS key disable or scheduled deletion events and notify for manual review.

    resource: aws.kms-key  

    mode:
      type: cloudtrail 
      role: arn:aws:iam::311278774159:role/custodian-lambda-role  
      events:
        - source: kms.amazonaws.com  
          event: DisableKey  
          ids: "requestParameters.keyId"  
        - source: kms.amazonaws.com
          event: ScheduleKeyDeletion  
          ids: "requestParameters.keyId"

    filters:
      - type: value
        key: KeyState  
        value: "Enabled"  

    actions:
      - type: notify
        template: default
        template_format: slack
        violation_desc: |
          *** CHECKID: "cloudwatch_log_metric_filter_disable_or_scheduled_deletion_of_kms_cmk" ***
            KMS 키가 비활성화되었거나 삭제 예약되었습니다.
        action_desc: |
           삭제/비활성화가 의도된 작업인지 검토 후 필요 시 `CancelKeyDeletion` 또는 키 재활성화를 수동으로 수행하세요.
        to:
          - "${SLACK_WEBHOOK_URL}"
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/${ACCOUNT_ID}/custodian-notify-queue
---
# 13-cloudwatch_log_metric_filter_for_s3_bucket_policy_changes.yml

# 위반 사항 : S3 버킷 정책 변경에 대한 로그 필터 및 경보가 없어 이상행위 탐지 및 접근권한 관리 절차 위반
# 자동 조치 X / 알림만 
# 이유 : Cloud Custodian은 S3 정책 변경을 사전 차단이 불가능하다.
# 변경 전 상태를 자동으로 복원하는 것도 정책의 복잡성(기존 정책 백업·관리) 때문에 어려움. 

policies:
  - name: notify-on-s3-bucket-policy-change 
    resource: aws.s3 
    description: Notify when S3 bucket policy is added or removed via CloudTrail

    mode:
      type: cloudtrail  
      role: arn:aws:iam::311278774159:role/custodian-lambda-role  
      events:
        - source: s3.amazonaws.com  
          event: PutBucketPolicy 
          ids: "requestParameters.bucketName" 
        - source: s3.amazonaws.com
          event: DeleteBucketPolicy 
          ids: "requestParameters.bucketName"

    filters:
      - type: value
        key: BucketPolicy
        value: not-null  

    actions:
      - type: notify
        template: default
        template_format: slack
        violation_desc: |
          *** CHECKID: "cloudwatch_log_metric_filter_for_s3_bucket_policy_changes" ***
          S3 버킷 정책이 생성되거나 삭제되었습니다.
        action_desc: |
          변경이 의도된 것인지 확인하고 필요한 경우 버킷 정책을 검토하거나 이전 상태로 복구하십시오.
        to:
          - "${SLACK_WEBHOOK_URL}"
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/${ACCOUNT_ID}/custodian-notify-queue
---