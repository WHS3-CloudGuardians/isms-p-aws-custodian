policies:
# CHECKID: ec2_ebs_default_encryption
# ACTIONPLAN: EBS 디폴트 암호화 설정 미적용 시 강제화
  - name: ec2_ebs_default_encryption
    description: Automatically enabled when basic EBS encryption is disabled
    resource: aws.account
    mode:
      type: cloudtrail
      role: arn:aws:iam::311278774159:role/custodian-test-role
      events:
        - source: ec2.amazonaws.com
          event: DisableEbsEncryptionByDefault
          ids: recipientAccountId
    filters:
      - type: default-ebs-encryption
        state: false
    actions:
      - type: set-ebs-encryption
        state: true
        key: arn:aws:kms:ap-northeast-2:311278774159:key/b2ce04c3-e17a-4da7-a491-d0d471ac4a8c


# CHECKID: ec2_ebs_volume_encryption
# ACTIONPLAN: 비암호화된 EBS 볼륨 스냅샷 생성 및 삭제를 이메일로 알림
  - name: ec2_ebs_volume_encryption-1
    description: Notify via email when creating and deleting unencrypted EBS volume snapshots
    resource: aws.ebs
    mode:
      type: periodic
      schedule: "rate(1 day)"
      role: arn:aws:iam::311278774159:role/custodian-lambda-role
    filters:
      - Encrypted: false
    actions:
      - type: snapshot
      - type: notify
        slack_template: slack_default
        slack_msg_color: danger
        violation_desc: |
	        *** CHECKID: ec2_ebs_volume_encryption ***
          • 비암호화된 EBS 볼륨이 감지되었습니다.
        action_desc: |
          1. 스냅샷 생성 완료  
          2. 원본 볼륨 삭제 여부를 검토해주세요.
        to:
          - https://hooks.slack.com/services/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
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/311278774159/custodian-notify-queue

# ACTIONPLAN: 비암호화된 스냅샷 암호화해서 복사 후 원본 삭제
  - name: ec2_ebs_volume_encryption-2
    description: Encrypt unencrypted snapshots, copy them, and then delete the originals
    resource: aws.ebs-snapshot
    mode:
      type: periodic
      schedule: "rate(1 day)"
      role: arn:aws:iam::311278774159:role/custodian-lambda-role
    filters:
      - Encrypted: false
    actions:
      # 암호화된 복사본 생성
      - type: copy
        target_region: ap-northeast-2
        encrypted: true
        target_key: alias/aws/ebs
      - type: delete

# CHECKID: ec2_ebs_volume_snapshots_exists
# ACTIONPLAN: 스냅샷 없는 EC2 인스턴스의 볼륨 스냅샷 생성 및 태그 복사
  - name: ec2_ebs_volume_snapshots_exists
    description: Creating volume snapshots and copying tags for EC2 instances without snapshots
    resource: aws.ebs
    mode:
      type: periodic
      schedule: "rate(1 day)"
      role: arn:aws:iam::311278774159:role/custodian-lambda-role
    filters:
      - type: snapshots
        count: 0
    actions:
      - type: snapshot
        copy-tags:
          - "*"
        tags:
          CloudCustodian: "true"
