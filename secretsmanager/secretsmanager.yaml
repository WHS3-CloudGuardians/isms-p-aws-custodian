# secretsmanager.yml

# 자동 조치 X / 알림만
# 위반 사항 : Secrets Manager 시크릿에 자동 회전(Rotation) 설정이 비활성화되어 암호키 관리 절차 위반
# 이유 : 시크릿 자동 회전은 사후 조치로 설정 변경이 가능하지만, 시크릿 자체가 민감한 정보를 포함하므로 운영 환경에서는 Slack 알림을 통해 점검·조치를 유도하는 것이 더 안전함
# 운영리스크가 있다. SecretsManager의 시크릿 자동 회전은 단순한 설정이 아니라 회전을 위한 Lambda 함수 구성, Rotation schedule 연결, IAM 권한 구성 등이 포함됩니다.
# 백엔드와의 인증이 끊기고 서비스 장애가 발생할 수 있습니다.

policies:  
  - name: notify-secret-without-rotation  
    resource: aws.secrets-manager  
    description: Automatic rotation is disabled for the Secrets Manager secret, violating proper secret key management procedures.

    mode:
      type: periodic 
      schedule: "rate(1 day)" 
      role: arn:aws:iam::311278774159:role/custodian-lambda-role 

    filters:
      - type: value
        key: RotationEnabled  
        value: false  

    actions:
      - type: notify  
        template: default
        template_format: slack
        violation_desc: |
          *** CHECKID : "secretsmanager_rotation_enabled" ***
          해당 Secrets Manager 시크릿은 자동 회전(Rotation) 설정이 비활성화되어 있습니다.
        action_desc: |
          자동 회전 설정은 Lambda 구성 및 IAM 권한이 포함되므로, 운영 리스크를 고려하여 수동 점검 및 설정을 권장합니다.
        to:
          - "${SLACK_WEBHOOK_URL}"
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/${ACCOUNT_ID}/custodian-notify-queue
