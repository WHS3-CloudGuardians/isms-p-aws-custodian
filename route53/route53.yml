# route53_public_hosted_zones_cloudwatch_logging_enabled.yml

# 자동 조치 X / 알림만
# 위반 사항 : Route53 공개 호스티드 존에 대해 CloudWatch Query Logging이 비활성화됨
# 이유 : Custodian은 Route53의 Query Logging을 직접 활성화하는 API 호출을 지원하지 않으므로 수동조치 유도

# 커스터디언 실행이 아예 되지 않음. 슬랙도 보낼 수 없음. 
# 리소스인 aws.route53-hostedzone이 기본 Cloud Custodian(기본 커스터디언은 pip install cloud-custodian을 지칭)에 없고, c7n_aws 플러그인에 포함되어 있다.
# 1. c7n_aws 플러그인이 git과 pip install c7n_aws 모두 실행이 되지 않는다. 설치가 되지 않음. 
# 2. 대체할 수 있는 리소스가 없음. Route53 Hosted Zone 정보는 이 리소스가 유일.
# => 따라서 해당 리소스는 보안 점검은 할 수가 없다. slack 알림도 보낼 수가 없음. 리소스가 없어서. 

policies:
  - name: alert-route53-public-zone-query-logging-disabled
    resource: aws.route53-hostedzone
    description: Public Route53 hosted zones have query logging disabled.

    mode:
      type: periodic
      schedule: "rate(1 hours)"  
      role: arn:aws:iam::311278774159:role/custodian-lambda-role  

    filters:
      - type: public-zone         
        value: true
      - type: query-logging-enabled
        enabled: false      

    actions:
      - type: notify
        template: default
        template_format: slack
        violation_desc: |
          *** CHECKID : route53_public_hosted_zones_cloudwatch_logging_enabled ***
          - Route53 공개 Hosted Zone에 대해 Query Logging이 비활성화되어 있습니다.
        action_desc: |
          - Query Logging을 수동으로 활성화해야 합니다.
        to:
          - alerts
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/311278774159/cloud-custodian-alert-queue
