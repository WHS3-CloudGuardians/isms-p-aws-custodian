# guardduty_is_enabled.yml

# 자동 조치 O 
# 위반 사항 : GuardDuty가 비활성화되어 이상행위 탐지가 불가능한 상태

policies:
  - name: alert-route53-public-zone-query-logging-disabled
    resource: aws.route53-hostedzone
    description: GuardDuty is disabled making it impossible to detect suspicious or anomalous activities.

    mode:
      type: periodic
      schedule: "rate(1 day)"
      role: arn:aws:iam::311278774159:role/custodian-lambda-role

    filters:
      - ConfigPublicZone: true
      - type: query-logging-enabled
        enabled: false

    actions:
      - type: notify
        template: default
        template_format: slack
        violation_desc: |
          *** CHECKID : "route53_query_logging_enabled" ***
          Route53 공개 호스티드 존에 대해 Query Logging이 설정되어 있지 않습니다.
        action_desc: |
          CloudWatch Logs 기반 Query Logging을 활성화하여 DNS 요청 이력을 추적할 수 있도록 설정하세요.
          Cloud Custodian에서는 해당 기능을 직접 활성화할 수 없으므로 수동 조치가 필요합니다.
        to:
          - https://hooks.slack.com/services/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
        transport:
          type: sqs
          queue: https://sqs.ap-northeast-2.amazonaws.com/311278774159/custodian-notify-queue
